language: python
sudo: required

matrix:
  include:
    - dist: trusty
      env: dist="14.04 LTS trusty"
    - dist: xenial
      env: dist="16.04 LTS xenial"

env:
  global:
    - secure: "jMxuqh0ei4AZlq61pATJS6TCnhzi22ywX5W5HwEup8Aa/1Dhago/HBkGNj4GH/c1kGf1NFm1mgFrIfOT8dLqOmsj44l+027rZ6xw9KuLJCTExViRg/Pyvj94zlkTXpSOpuXknRa+luDOUTSHG8NTbGCZZgQ9ybMTv7bPnwID0oDGa4E8R0KpJSZ+MS5mC2k5SQNusHqwn1ZHr/J+mH0fDCLvlBTDmRl1YfFLz5AcITr3ixZcgVQQeXEP2cAphoyMs87HK1A/iMnbu34dqOZ/WyvXE+ynhnxXrMDS9vUWjXz45Wx9w4lWtnMwQRshlGzhH5u44Gqg6zmxrxkcy87ZWrdRp85cYGoG164gR1RfHK0QyEebyKSlezvfpTAsMR0ZW9xdVIEMJJzrK3T8FL6bC/GnYe0xx9F4i9DX0VkNvUc6mvCaALLpcmszxVkzsalRdMQz5RXYlZNvHRVBaoyMHjqS7F5CGvvM3kOUSPkD3m9AAngGfCnR2Pgqern0q7wqVOZGhVUW/a3555U20nBaXMvKRejERkF6MbJ0X9kaTl/6Za8v9Yxnxn5ugB0EJaJVzsjjncCWiCo5O3uM46E4YHGxF8jUl//p45t0jm39H+9JZay9hL+NS11DVNoY7n57u7oAoyOpkL7q7+j4L1s2n3V6kcaHhn8h/AbFOxuieCM=" # DOCKER_USER
    - secure: "jt0/UPTEyy1Rouod/RQzoyFouYx9Zj8r7k24pyhAKt0ps/Y+AEL7U7NTXsY/cfSHBZQotBVXenadgIniM0CBVs0YDI4u66tveqVsrALoRXRadUbT337QS3udVu7AAufceqNkyophudd9AJ6+uBL2DVUd/RDinNZwZCSF5SsK2Bde8Vh+5MVmSwLuIT2jzikYXIF9eySKXY3Q2MAII5577l+kXBc29/20wlteVBLs3kxOcyYKctis9LwlU75oASPpusLrs47ZWtJiVQA5Tkh4ulHAvtbFQvZiWxzsDAiIZzbXEeiGaU30mjiOSwFzCQksaptwUFYcYSoJAtHm59XgQmh3APmXbHCLRjdQrcra1C1fatvNeL0lJ1Vfj3n/lfhhJiEp/hsRGRLl02z4WqyrnigUqWUrM3WAvthG02HaW/y1yMj7qW+IYdoxkkVWowg+IfBbUxtZkhxhx0MfZT1hNfrIr53ll7YpHaUEC6iMQSEPYCtsQ39vtexcmPfAhhxpDPryYDlkn4ZRE4KOqAwlng8UHkrN+NklSQ6U8RelraxYkON7Wi3sVsOCCaq1q3pWmgXi4XCSdANEXiNkIAtjNeXZbum3HFJCe/Y9byT58VISbbfzvnaeTQoysB6shBVXQgCKETccm/hXQqcnFiN5ENvYJmr9+ULxoZz++gDP24U=" # DOCKER_PASS
    - COMMIT=${TRAVIS_COMMIT::8}

virtualenv:
  system_site_packages: true

before_install:
  - sudo apt-get -qq update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -y install ansible libffi-dev libssl-dev

# installation
install:
  - cd ansible; sudo ansible-playbook -i "localhost," -c local -v install.yml; cd ..

# run tests
script:
  - env
  # run unit tests
  - sudo py.test -v mininet/test/test_containernet.py
  # build docker container (also checks in-docker installation)
  - docker build -t containernet/containernet:$COMMIT .

# do docker push to dockerhub (use only 14.04 for this)
after_success:
  - if [ "$dist" == "14.04 LTS trusty" ]; then
    docker login -u=$DOCKER_USER -p=$DOCKER_PASS;
    export REPO="containernet/containernet";
    export TAG=`if [ -n "$TRAVIS_PULL_REQUEST_BRANCH" ]; then echo "pr$TRAVIS_PULL_REQUEST"; else echo "latest"; fi`;
    docker tag $REPO:$COMMIT $REPO:$TAG;
    docker images;
    docker push $REPO:$TAG;
    fi

notifications:
  email:
    on_success: change
    on_failure: always
