language: python
sudo: required

matrix:
  include:
    - dist: trusty
      env: dist="14.04 LTS trusty"
    - dist: xenial
      env: dist="16.04 LTS xenial"

env:
  global:
    - COMMIT=${TRAVIS_COMMIT::8}

virtualenv:
  system_site_packages: true

before_install:
  - sudo apt-get -qq update
  - sudo DEBIAN_FRONTEND=noninteractive apt-get -y install ansible libffi-dev libssl-dev

# installation
install:
  - cd ansible; sudo ansible-playbook -i "localhost," -c local -v install.yml; cd ..

# run tests
script:
  - env
  # run unit tests
  - sudo py.test -v mininet/test/test_containernet.py
  # build docker container (also checks in-docker installation)
  - docker build -t containernet/containernet:$COMMIT .

# do docker push to dockerhub (use only 14.04 for this)
after_success:
  #- if [ "$dist" == "14.04 LTS trusty" ]; then
  - docker login -u="$DOCKER_USERNAME" -p="$DOCKER_PASSWORD";
  - export REPO="containernet/containernet";
  - export TAG=`if [ -n "$TRAVIS_PULL_REQUEST_BRANCH" ]; then echo "pr$TRAVIS_PULL_REQUEST"; else echo "latest"; fi`;
  - docker tag $REPO:$COMMIT $REPO:$TAG;
  - docker images;
  - docker push $REPO:$TAG;
  #  fi

notifications:
  email:
    on_success: change
    on_failure: always
